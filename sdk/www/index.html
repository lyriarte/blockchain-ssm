<html>
<head>
  <title>Signing State Machines</title>
</head>

<script src="crypto-js/crypto-js.js"></script>
<script src="jsencrypt/jsencrypt.js"></script>
<script src="vis/vis.js"></script>

<script src="bcc-xmlhttp.js"></script>
<script src="ssm-api.js"></script>
<script src="ssm-view.js"></script>
<script type="text/javascript">

function logResult(result) {
	document.getElementById('data__Fld').value = JSON.stringify(JSON.parse(result),null,2);
}

function logSSM(result) {
	logResult(result);
	var ssm = JSON.parse(result);
	var cnv = document.getElementById('ssm__Cnv');
	ssmView(ssm, cnv);
}

function logSignature() {
	var txt = document.getElementById('txt__Fld').value;
	var prv = document.getElementById('prv__Fld').value;
	JSE.setPrivateKey(prv);
	var sgn = JSE.sign(txt, CryptoJS.SHA256, "sha256");
	document.getElementById('data__Fld').value = sgn;
}

function logFlatPublicKey() {
	var pub = document.getElementById('pub__Fld').value;
	document.getElementById('data__Fld').value = flattenPublicKey(pub);
}

function logPublicKey() {
	var prv = document.getElementById('prv__Fld').value;
	JSE.setPrivateKey(prv);
	var pub = JSE.getPublicKey();
	document.getElementById('pub__Fld').value = pub;
}

function genPrivateKey() {
	var prv = JSE.getPrivateKey(prv);
	document.getElementById('prv__Fld').value = prv;
}

function ssmQuerySetup() {
	var uri = "http://" + document.getElementById('host__Fld').value + ":" + document.getElementById('port__Fld').value;
	var fcn = document.getElementById('query__Sel').value;
	var queryId = document.getElementById('query__Fld').value;
	var hostCmd = ssmQuery(fcn, queryId);
	bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logSSM, logResult);
}

function ssmListSetup() {
	var uri = "http://" + document.getElementById('host__Fld').value + ":" + document.getElementById('port__Fld').value;
	var fcn = "list";
	var queryType = document.getElementById('query__Sel').value;
	var hostCmd = ssmQuery(fcn, queryType);
	bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logSSM, logResult);
}

function ssmLogSetup() {
	var uri = "http://" + document.getElementById('host__Fld').value + ":" + document.getElementById('port__Fld').value;
	var fcn = "log";
	var queryId = document.getElementById('query__Fld').value;
	var hostCmd = ssmQuery(fcn, queryId);
	bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logSSM, logResult);
}

function ssmRegisterSetup() {
	var uri = "http://" + document.getElementById('host__Fld').value + ":" + document.getElementById('port__Fld').value;
	var user = {
		name: document.getElementById('user__Fld').value,
		pub: flattenPublicKey(document.getElementById('pub__Fld').value)
	}
	document.getElementById('data__Fld').value = JSON.stringify(user,null,2);
	var admin = document.getElementById('agent__Fld').value;
	var adminKey = document.getElementById('prv__Fld').value;
	var hostCmd = ssmRegister(user, admin, adminKey);
	bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logResult);
}

function ssmCreateSetup() {
	var uri = "http://" + document.getElementById('host__Fld').value + ":" + document.getElementById('port__Fld').value;
	var ssm = JSON.parse(document.getElementById('data__Fld').value);
	var admin = document.getElementById('agent__Fld').value;
	var adminKey = document.getElementById('prv__Fld').value;
	var hostCmd = ssmCreate(ssm, admin, adminKey);
	bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logResult);
}

function ssmStartSetup() {
	var uri = "http://" + document.getElementById('host__Fld').value + ":" + document.getElementById('port__Fld').value;
	var session = JSON.parse(document.getElementById('data__Fld').value);
	var admin = document.getElementById('agent__Fld').value;
	var adminKey = document.getElementById('prv__Fld').value;
	var hostCmd = ssmStart(session, admin, adminKey);
	bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logResult);
}

function ssmPerformSetup() {
	var uri = "http://" + document.getElementById('host__Fld').value + ":" + document.getElementById('port__Fld').value;
	var context = JSON.parse(document.getElementById('data__Fld').value);
	var action = document.getElementById('action__Fld').value;
	var user = document.getElementById('agent__Fld').value;
	var userKey = document.getElementById('prv__Fld').value;
	var hostCmd = ssmPerform(action, context, user, userKey);
	bccHostCmd(uri, hostCmd.cmd, hostCmd.fcn, hostCmd.args, logResult, logResult);
}


</script>

<body>

<center><h1>Signing State Machines</h1></center>

<h2>Host gateway</h2>
Host address <input type="text" size="12" value="127.0.0.1" id="host__Fld">:<input type="text" size="6" value="8080" id="port__Fld">

<table>
<tr>
<td>
<h2>Private key</h2>
<textarea rows="28" cols="64" id="prv__Fld">
</textarea>
<br>
<input type="button" value="generate" onclick="genPrivateKey()"/>
<input type="button" value="public" onclick="logPublicKey()"/>
</td>
<td>
<input type="button" value="query" onclick="ssmQuerySetup()"/>
<input type="button" value="log" onclick="ssmLogSetup()"/>
<input type="button" value="list" onclick="ssmListSetup()"/>
<select id="query__Sel">
  <option value="admin" selected>Admin</option>
  <option value="user">User</option>
  <option value="ssm">SSM</option>
  <option value="session">Session</option>
</select>
<input type="text" size="12" id="query__Fld"/>
<br>
<b>Signer agent: </b><input type="text" size="12" id="agent__Fld">
<br>
<input type="button" value="register" onclick="ssmRegisterSetup()"/> user: <input type="text" size="12" id="user__Fld"/>
<br>
<input type="button" value="perform" onclick="ssmPerformSetup()"/> action: <input type="text" size="12" id="action__Fld"/>
<br>
<input type="button" value="create SSM" onclick="ssmCreateSetup()"/>
<input type="button" value="start session" onclick="ssmStartSetup()"/>
<h3>Data</h3>
<textarea rows="16" cols="32" id="data__Fld">
</textarea>
<br>
</td>

<td id="ssm__Cnv" rowspan="2" style="width:100%;height:100%">
</td>

</tr>
<tr>
<td colspan="2">
<h2>Public key</h2>
<textarea rows="8" cols="64" id="pub__Fld">
</textarea>
<br>
<input type="button" value="flatten" onclick="logFlatPublicKey()"/>

<h2>Text to sign</h2>
<textarea rows="4" cols="64" id="txt__Fld">
</textarea>
<br>
<input type="button" value="sign" onclick="logSignature()"/>
</td>

</tr>
</table>

</body>
</html>
